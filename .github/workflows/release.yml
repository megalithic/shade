name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build macOS ARM64
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build with Nix
        run: nix build .#shade -o result

      - name: Determine version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            # Tagged release: use tag name (e.g., v0.1.0)
            VERSION="${GITHUB_REF_NAME}"
            RELEASE_NAME="${VERSION}"
            PRERELEASE="false"
          else
            # Main branch: use short SHA
            SHORT_SHA="${GITHUB_SHA::7}"
            VERSION="latest"
            RELEASE_NAME="latest (${SHORT_SHA})"
            PRERELEASE="true"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "release_name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Prepare release artifacts
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARTIFACT_NAME="shade-${VERSION}-darwin-arm64"

          mkdir -p dist

          # Copy binary
          cp result/bin/shade dist/shade

          # Create tarball
          cd dist
          tar -czf "${ARTIFACT_NAME}.tar.gz" shade

          # Generate SHA256 checksum
          shasum -a 256 "${ARTIFACT_NAME}.tar.gz" > "${ARTIFACT_NAME}.tar.gz.sha256"

          # Also provide raw binary for direct download
          gzip -c shade > "${ARTIFACT_NAME}.gz"
          shasum -a 256 "${ARTIFACT_NAME}.gz" > "${ARTIFACT_NAME}.gz.sha256"

          echo "Created artifacts:"
          ls -la

      - name: Delete existing latest release
        if: steps.version.outputs.version == 'latest'
        run: gh release delete latest --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.release_name }}
          prerelease: ${{ steps.version.outputs.prerelease }}
          files: |
            dist/*.tar.gz
            dist/*.tar.gz.sha256
            dist/*.gz
            dist/*.gz.sha256
          fail_on_unmatched_files: true
          generate_release_notes: true
